# Workshop: Testing with Fake Data

A workshop demonstrating how to test Python applications using databases in Docker, for ETL and RestAPI purposes. This workshop uses SQLModel for data models, FastAPI for API development, and fake data generated by Factory Boy and Faker. You will need to have Docker preinstalled.

## Learning Objectives

After completing this workshop, you will understand:

- **Factory Boy Patterns** - Generating fake data for testing
- **Database Testing Strategies** - Unit, integration, and Docker-based testing
- **SQLModel & FastAPI Integration** - Modern Python data stack
- **ETL Testing** - Test data transformation and processing flows
- **Test Organization** - Structure tests with pytest markers and fixtures

## Project Structure

```
├── src/
│   ├── app/                       # FastAPI application
│   │   ├── api/
│   │   │   ├── crud/              # CRUD operations
│   │   │   └── routes/            # API routes
│   │   ├── create_app             # FastAPI app factory
│   │   └── main.py                # Application entry point
│   ├── models/
│   │   ├── v1/                    # SQLModel models
│   │   └── faker_models/
│   │       └── db/                # Factory Boy factories
│   ├── etl/                       # ETL processes
│   │   ├── apis/                  # External API clients
│   │   ├── flows/                 # ETL workflows
│   │   └── main.py                # ETL CLI entry point
│   └── shared/                    # Shared utilities
│       ├── engine                 # Database engine
│       └── settings               # Configuration
├── tests/
│   ├── conftest                   # Pytest configuration
│   ├── app/
│   │   ├── conftest               # App test fixtures
│   │   └── api/
│   │       ├── crud/              # CRUD tests
│   │       └── routes/            # Route tests
│   └── etl/
│       ├── conftest               # ETL test fixtures
│       ├── utils                  # Test utilities
│       ├── apis/                  # API client tests
│       └── flows/                 # ETL flow tests
├── db-init-scripts/               # Database initialization
├── .env.dist                      # Environment template
├── compose.yml                    # Docker services
├── pyproject.toml                 # Project dependencies
└── README.md
```

## Quick Start

**Prerequisites**

You need to have Docker installed.

1. UV (package manager)

    Install [UV](https://docs.astral.sh/uv/#installation) also manages your virtual environment and python versions (if needed).

    ```bash
    uv sync --all-groups
    ```

    If you don't use python 3.12 or higher
    ```bash
    uv python install 3.12
    ```

2. Start the database in detached mode

    ```bash
    docker compose up -d
    ```

3. Run tests:
   ```bash
   # Unit tests (no database required)
   pytest -m unit

   # Docker tests (requires database)
   pytest -m docker

   # All tests
   pytest
   ```

4. Run the ETL
   ```bash
   python -m etl.main
   ```

5. Start the API (Optional):
   ```bash
   uvicorn app.main:app --reload --host 0.0.0.0 --port 8080
   ```

### Test Markers
- `@pytest.mark.unit`: Tests that don't require a database
- `@pytest.mark.docker`: Tests that require the Docker database
- `@pytest.mark.integration`: Tests that require external services


## Tasks

In this workshop, an example has been provided that retrieves the number of houses (aantal woningen) built per municipality (gemeente) for the last 10 years from Centraal Bureau voor Statistiek (CBS). This data is then stored in a database. And is then used to create a RestAPI endpoint to provide this information in a similar format.

**Objective**

What we want to do now, is to enrich this data with other data from the CBS. For example, with the sale prices of houses (for which the data endpoint has already been provided in `CbsApi`), in order to create an endpoint that combines the number of houses built with the sale price of houses in a district for the last 10 years.

```python
# api/{gm_code}/housing should return
{
   "year": ...,
   "aantal_woningen": ...,
   "verkocht_woningen": ...,
   "gemiddelde_verkoopprijs": ...
}
```
**Tasks**

- Add a test for `CbsApi`'s `get_verkoopprijzen`
- Create a new SQLModel that represents that data in the database
- Based on the SQLModel create a SQLAlchemyModelFactory to create SQLModel objects with fake data to use in tests
- Create a new 'flow' to extract data retrieved from get_verkoopprijzen in `CbsApi`, add test
- Create new, or use existing Crud class with a function to read the new data from database, add test
- Create new route to retrieve the new data, add test


Bonus
- Visualise results
- Retrieve data for specific year with query parameters (https://fastapi.tiangolo.com/tutorial/query-params/)
- Add other data sources from CBS, this is number of houses ([https://www.cbs.nl/nl-nl/cijfers/detail/81955NED](https://www.cbs.nl/nl-nl/cijfers/detail/81955NED))
