# Workshop: Testing with Fake Data

A workshop demonstrating how to test Python applications using databases in Docker, for ETL and RestAPI purposes. This workshop uses SQLModel for data models, FastAPI for API development, and fake data generated by Factory Boy and Faker. You will need to have Docker preinstalled.

## Learning Objectives

After completing this workshop, you will understand:

- **[Factory Boy](https://factoryboy.readthedocs.io/en/stable/orms.html#factory.alchemy.SQLAlchemyOptions)  Patterns** - Generating fake data for testing
- **Database Testing Strategies** - Unit, integration, and Docker-based testing
- **[SQLModel](https://sqlmodel.tiangolo.com/) & [FastAPI](https://fastapi.tiangolo.com/) Integration** - Modern Python data stack
- **ETL Testing** - Test data transformation and processing flows
- **[Pytest](https://docs.pytest.org/en/stable/contents.html) tests Organization** - Structure tests with pytest markers and fixtures

## Project Structure

```
├── src/
│   ├── app/                       # FastAPI application
│   │   ├── api/
│   │   │   ├── crud/              # CRUD operations
│   │   │   └── routes/            # API routes
│   │   ├── create_app             # FastAPI app factory
│   │   └── main.py                # Application entry point
│   ├── models/
│   │   ├── v1/                    # SQLModel models
│   │   └── faker_models/
│   │       └── db/                # Factory Boy factories
│   ├── etl/                       # ETL processes
│   │   ├── apis/                  # External API clients
│   │   ├── flows/                 # ETL workflows
│   │   └── main.py                # ETL CLI entry point
│   └── shared/                    # Shared utilities
│       ├── engine                 # Database engine
│       └── settings               # Configuration
├── tests/
│   ├── conftest                   # Pytest configuration
│   ├── app/
│   │   ├── conftest               # App test fixtures
│   │   └── api/
│   │       ├── crud/              # CRUD tests
│   │       └── routes/            # Route tests
│   └── etl/
│       ├── conftest               # ETL test fixtures
│       ├── utils                  # Test utilities
│       ├── apis/                  # API client tests
│       └── flows/                 # ETL flow tests
├── db-init-scripts/               # Database initialization
├── .env.dist                      # Environment template
├── compose.yml                    # Docker services
├── pyproject.toml                 # Project dependencies
└── README.md
```

## Quick Start

**Prerequisites**

You need to have Docker installed.

1. UV (package manager)

    Install [UV](https://docs.astral.sh/uv/#installation) also manages your virtual environment and python versions (if needed).

    ```bash
    uv sync --all-groups
    ```

    If you don't have python 3.12 or higher
    ```bash
    uv python install 3.12
    ```

2. Start the database in detached mode

    ```bash
    docker compose up -d
    ```

3. Activate virtual environment

   ```bash
   source ./venv/bin/activate
   ```

4. Run tests:
   ```bash
   # Unit tests (no database required)
   pytest -m unit

   # Docker tests (requires database)
   pytest -m docker

   # All tests
   pytest
   ```

5. Run the ETL
   ```bash
   python -m etl.main
   ```

6. Start the API (Optional):
   ```bash
   uvicorn app.main:app --reload --host 0.0.0.0 --port 8080
   ```

### Test Markers
- `@pytest.mark.unit`: Tests that don't require a database
- `@pytest.mark.docker`: Tests that require the Docker database
- `@pytest.mark.integration`: Tests that require external services


## Tasks

In this workshop, an example has been provided that retrieves the number of houses (aantal woningen) built per municipality (gemeente) for the last 10 years from Centraal Bureau voor Statistiek (CBS). This data is then stored in a database. And is then used to create a RestAPI endpoint to provide this information in a similar format.

**Objective**

What we want to do now, is to enrich this data with other data from the CBS. For example, with the sale prices of houses (for which the data endpoint has already been provided in [CbsApi](src/etl/apis/cbs.py)), in order to create an endpoint that combines the number of houses built with the sale price of houses in a district for the last 10 years.

```python
# api/{gm_code}/housing should return
{
   "year": ...,
   "aantal_woningen": ...,
   "verkochte_woningen": ...,
   "gemiddelde_verkoopprijs": ...
}
```
**Tasks**

- Create a new SQLModel that represents the "verkochte_woningen" and "gemiddelde_verkoopprijs" data in the database
There already is a model for the [aantal woningen](src/models/v1/cbs_aantal_woningen.py)
- Create a new 'flow' that extracts data retrieved from get_verkoopprijzen in [CbsApi](src/etl/apis/cbs.py) and loads it to the database using the [SqlmodelLoader](src/etl/flows/base.py)

You may also want to write a [test](tests/etl/flows/test_cbs_aantal_woningen.py) making use the database running inside of docker

hint: the get_verkoopprijzen function returns a list of dicts (records), an individual record may look like this:
```python
{'ID': 2, 'RegioS': 'NL01  ', 'Perioden': '1995KW03', 'PrijsindexVerkoopprijzen_1': 30, 'OntwikkelingTOVVoorgaandePeriode_2': 2.3, 'OntwikkelingTOVEenJaarEerder_3': None, 'VerkochteWoningen_4': 40498, 'OntwikkelingTOVVoorgaandePeriode_5': 9.3, 'OntwikkelingTOVEenJaarEerder_6': None, 'GemiddeldeVerkoopprijs_7': 95819, 'TotaleWaardeVerkoopprijzen_8': 3880}
```

hint: check out the [run_cbs_aantal_woningen_flow](src/etl/flows/cbs_aantal_woningen.py)


- Create a SQLAlchemyModelFactory for for your newly created model to create SQLModel objects with fake data to use in tests. The existing faker models can be found
[here](src/models/faker_models/db/fake_models.py)
- Create a new, or use the [existing](src/app/api/crud/cbs.py) Crud class with a function to read the new data from database. Create a [test](tests/app/api/crud/test_cbs.py) by generating data using the faker model
- Create new [endpoint](src/app/api/routes/cbs_aantal_woningen.py) for our api that retrieves the new data.
Create a [test](tests/app/api/routes/test_cbs.py) using the TestClient that simulates a call to our api using the TestClient

Bonus
- If you have not done so already, you can try to create a factory that can generate fake output for [get_verkoopprijzen](src/etl/apis/cbs.py). You can set model = dict instead of a SQLModel class to create a factory that generates dicts. You may want to be more specific than an abitrary string when specifying the fields.
- We may want to generate test data for our test environment. Can you do this using the same SQLModel factories?
- Have a look at the [bad_test_get_aantal_woningen](tests/app/api/crud/test_cbs.py)
Can you explain why this test works?
Can you think of a problem a test like this may cause?
- It is possible to create a batch of random data using [create_batch](https://factoryboy.readthedocs.io/en/stable/reference.html#factory.Factory.create_batch). Can you use this to create a relevant test?
- Visualise results
- Retrieve data for specific year with query parameters (https://fastapi.tiangolo.com/tutorial/query-params/)
- Add other data sources from CBS, this is number of houses ([https://www.cbs.nl/nl-nl/cijfers/detail/81955NED](https://www.cbs.nl/nl-nl/cijfers/detail/81955NED))
